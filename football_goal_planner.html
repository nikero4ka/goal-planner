<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ü–µ–ª–µ–π ¬∑ –§—É—Ç–±–æ–ª</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Simple progress bar */
    .progress { height: 8px; background: #e5e7eb; border-radius: 9999px; overflow: hidden;}
    .progress > div { height: 100%; background: #3b82f6; }
    .chip { @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100; }
    .btn { @apply inline-flex items-center gap-1 px-3 py-2 rounded-lg border bg-white hover:bg-gray-50; }
    .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700 border-blue-600; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-10 backdrop-blur bg-white/70 border-b">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üéØ</span>
        <h1 class="text-xl sm:text-2xl font-semibold">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ü–µ–ª–µ–π ¬∑ –§—É—Ç–±–æ–ª</h1>
      </div>
      <div class="flex gap-2">
        <button id="btnNewGoal" class="btn btn-primary">+ –ù–æ–≤–∞—è —Ü–µ–ª—å</button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <!-- Stats -->
    <section id="stats" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-4">
      <div class="rounded-2xl bg-white border p-4">
        <div class="text-sm text-gray-500">–í—Å–µ–≥–æ —Ü–µ–ª–µ–π</div>
        <div id="statTotal" class="text-2xl font-bold">0</div>
      </div>
      <div class="rounded-2xl bg-white border p-4">
        <div class="text-sm text-gray-500">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
        <div id="statCompleted" class="text-2xl font-bold">0</div>
      </div>
      <div class="rounded-2xl bg-white border p-4">
        <div class="text-sm text-gray-500">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
        <div id="statOverdue" class="text-2xl font-bold">0</div>
      </div>
      <div class="rounded-2xl bg-white border p-4">
        <div class="text-sm text-gray-500">–ú–∏–Ω—É—Ç —Ç—Ä–µ–Ω. (–≤—Å—ë –≤—Ä–µ–º—è)</div>
        <div id="statTrainMin" class="text-2xl font-bold">0</div>
      </div>
      <div class="rounded-2xl bg-white border p-4">
        <div class="text-sm text-gray-500">–ú–∞—Ç—á–µ–π –≤ –º–µ—Å.</div>
        <div id="statMatchMonth" class="text-2xl font-bold">0</div>
      </div>
    </section>

    <!-- Points -->
    <section class="rounded-2xl bg-white border p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">üèÜ –û—á–∫–∏</h2>
        <div class="text-2xl font-bold" id="pointsTotal">0</div>
      </div>
      <div class="text-sm text-gray-500">–ò–∑ –º–∞—Ç—á–µ–π: <span id="pointsFromMatches">0</span></div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 items-end">
        <label class="block text-sm">
          –ë–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏ (—Ä—É—á–Ω–æ–π —É—á—ë—Ç)
          <input id="bonusPoints" type="number" class="mt-1 w-full rounded-lg border px-3 py-2" value="0"/>
        </label>
        <p class="text-xs text-gray-500">–°–æ–≤–µ—Ç: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–Ω—É—Å –¥–ª—è —Å–≤–æ–∏—Ö –º–µ—Ç—Ä–∏–∫ (–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞, —Ç–∞–∫—Ç–∏–∫–∞ –∏ —Ç.–ø.).</p>
      </div>
    </section>

    <!-- Filters -->
    <section class="rounded-2xl bg-white border p-4">
      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between">
        <div class="flex items-center gap-2 flex-wrap">
          <button class="btn" data-filter="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
          <button class="btn" data-filter="all">–í—Å–µ</button>
          <button class="btn" data-filter="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</button>
          <button class="btn" data-filter="thisWeek">–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</button>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="categoryFilter" class="rounded-lg border px-3 py-2 w-44">
            <option value="all">–í—Å–µ</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Football sections -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Trainings -->
      <div class="rounded-2xl bg-white border p-4">
        <h2 class="text-base font-semibold mb-3">üí™ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h2>
        <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 items-end">
          <label class="text-sm">–î–∞—Ç–∞
            <input id="trainDate" type="date" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm">–¢–∏–ø
            <select id="trainType" class="mt-1 w-full rounded-lg border px-3 py-2">
              <option>–¢–µ—Ö–Ω–∏–∫–∞</option>
              <option>–¢–∞–∫—Ç–∏–∫–∞</option>
              <option>–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å</option>
              <option>–°–∫–æ—Ä–æ—Å—Ç—å</option>
              <option>–°–∏–ª–æ–≤–∞—è</option>
              <option>–î—Ä—É–≥–æ–µ</option>
            </select>
          </label>
          <label class="text-sm">–ú–∏–Ω—É—Ç—ã
            <input id="trainMinutes" type="number" value="60" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (1‚Äì5)
            <input id="trainIntensity" type="number" min="1" max="5" value="3" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <button id="addTraining" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
          <label class="text-sm sm:col-span-5">–ó–∞–º–µ—Ç–∫–∏
            <input id="trainNotes" class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="–ù–∞–ø—Ä., –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–π –±–µ–≥ 6√ó400–º"/>
          </label>
        </div>
        <div id="trainingList" class="mt-3 space-y-2 text-sm"></div>
      </div>

      <!-- Matches -->
      <div class="rounded-2xl bg-white border p-4">
        <h2 class="text-base font-semibold mb-3">üìÖ –ú–∞—Ç—á–∏</h2>
        <div class="grid grid-cols-1 sm:grid-cols-7 gap-2 items-end">
          <label class="text-sm">–î–∞—Ç–∞
            <input id="matchDate" type="date" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm sm:col-span-2">–°–æ–ø–µ—Ä–Ω–∏–∫
            <input id="matchOpponent" class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="–ù–∞–ø—Ä., FC Ajax U19"/>
          </label>
          <label class="text-sm sm:col-span-2">–¢—É—Ä–Ω–∏—Ä
            <input id="matchCompetition" class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="–õ–∏–≥–∞/–ö—É–±–æ–∫"/>
          </label>
          <label class="text-sm">–ú–∏–Ω—É—Ç—ã
            <input id="matchMinutes" type="number" value="90" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm">–ì–æ–ª—ã
            <input id="matchGoals" type="number" value="0" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm">–ê—Å—Å–∏—Å—Ç—ã
            <input id="matchAssists" type="number" value="0" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm">–û—Ü–µ–Ω–∫–∞ (1‚Äì10)
            <input id="matchRating" type="number" value="7" min="1" max="10" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm">–†–µ–∑—É–ª—å—Ç–∞—Ç
            <select id="matchResult" class="mt-1 w-full rounded-lg border px-3 py-2">
              <option value="W">–ü–æ–±–µ–¥–∞</option>
              <option value="D">–ù–∏—á—å—è</option>
              <option value="L">–ü–æ—Ä–∞–∂–µ–Ω–∏–µ</option>
            </select>
          </label>
          <button id="addMatch" class="btn btn-primary sm:col-span-2">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç—á</button>
          <label class="text-sm sm:col-span-7">–ó–∞–º–µ—Ç–∫–∏
            <input id="matchNotes" class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="–ù–∞–ø—Ä., —Å—ã–≥—Ä–∞–ª —Å–ª–µ–≤–∞, xG 0.4"/>
          </label>
        </div>
        <div id="matchList" class="mt-3 space-y-2 text-sm"></div>
      </div>
    </section>

    <!-- Goals list -->
    <section id="goalsSection"></section>
  </main>

  <!-- Modal for new goal -->
  <dialog id="goalDialog" class="rounded-2xl border p-0 w-full max-w-2xl backdrop:bg-black/30">
    <form method="dialog" class="p-0 m-0">
      <div class="p-4 border-b"><div class="text-lg font-semibold" id="goalDialogTitle">–ù–æ–≤–∞—è —Ü–µ–ª—å</div></div>
      <div class="p-4 space-y-3">
        <label class="block text-sm">–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏
          <input id="gTitle" required class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="–ù–∞–ø—Ä., –£–ª—É—á—à–∏—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å"/>
        </label>
        <label class="block text-sm">–û–ø–∏—Å–∞–Ω–∏–µ
          <textarea id="gDesc" class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="–ö–∞–∫ –∏–∑–º–µ—Ä–∏—Ç—å —É—Å–ø–µ—Ö, –ø–æ—á–µ–º—É –≤–∞–∂–Ω–æ"></textarea>
        </label>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <label class="block text-sm">–ö–∞—Ç–µ–≥–æ—Ä–∏—è
            <select id="gCategory" class="mt-1 w-full rounded-lg border px-3 py-2">
              <option>–°–ø–æ—Ä—Ç</option><option>–õ–∏—á–Ω–æ–µ</option><option>–£—á—ë–±–∞</option><option>–†–∞–±–æ—Ç–∞</option><option>–§–∏–Ω–∞–Ω—Å—ã</option><option>–ó–¥–æ—Ä–æ–≤—å–µ</option><option>–î—Ä—É–≥–æ–µ</option>
            </select>
          </label>
          <label class="block text-sm">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
            <select id="gPriority" class="mt-1 w-full rounded-lg border px-3 py-2"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select>
          </label>
          <label class="block text-sm">–î–µ–¥–ª–∞–π–Ω
            <input id="gDue" type="date" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
        </div>
        <div class="grid items-center gap-2">
          <div class="flex items-center gap-3 text-sm">
            <span>–†–µ–∂–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:</span>
            <label class="inline-flex items-center gap-2"><input type="radio" name="pmode" value="tasks" checked /> –ü–æ–¥–∑–∞–¥–∞—á–∏</label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="pmode" value="percent" /> % –≤—Ä—É—á–Ω—É—é</label>
          </div>
          <label class="block text-sm" id="percentWrap" style="display:none">–¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å (%)
            <input id="gPercent" type="number" min="0" max="100" value="0" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
        </div>
      </div>
      <div class="p-4 border-t flex justify-end gap-2">
        <button class="btn" value="cancel">–û—Ç–º–µ–Ω–∞</button>
        <button id="goalSave" class="btn btn-primary" value="default">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </dialog>

  <template id="goalCardTpl">
    <div class="rounded-2xl bg-white border p-4 space-y-3"></div>
  </template>

  <script>
    // ---- Utilities ----
    const STORAGE_GOALS = "goal-planner:data:v1";
    const STORAGE_TRAININGS = "goal-planner:trainings:v1";
    const STORAGE_MATCHES = "goal-planner:matches:v1";
    const STORAGE_POINTS_BONUS = "goal-planner:points-bonus:v1";

    const todayISO = () => new Date().toISOString().slice(0,10);
    const uid = () => Math.random().toString(36).slice(2,10);
    const fmtDate = (d) => d ? new Date(d + "T00:00:00").toLocaleDateString() : "‚Äî";
    const clamp = (n, min=0, max=100) => Math.max(min, Math.min(max, n));
    const isOverdue = (d) => { if (!d) return false; const t=new Date(todayISO()); const x=new Date(d + "T00:00:00"); return x < t; };

    // ---- State ----
    let goals = [];
    let trainings = [];
    let matches = [];
    let bonusPoints = 0;
    let filter = "active";
    let category = "all";

    // ---- Load/Save ----
    function loadAll() {
      try { goals = JSON.parse(localStorage.getItem(STORAGE_GOALS) || "[]"); } catch {}
      try { trainings = JSON.parse(localStorage.getItem(STORAGE_TRAININGS) || "[]"); } catch {}
      try { matches = JSON.parse(localStorage.getItem(STORAGE_MATCHES) || "[]"); } catch {}
      try { bonusPoints = Number(localStorage.getItem(STORAGE_POINTS_BONUS) || "0"); } catch {}
      document.getElementById('bonusPoints').value = String(bonusPoints);
    }
    function saveGoals(){ localStorage.setItem(STORAGE_GOALS, JSON.stringify(goals)); }
    function saveTrainings(){ localStorage.setItem(STORAGE_TRAININGS, JSON.stringify(trainings)); }
    function saveMatches(){ localStorage.setItem(STORAGE_MATCHES, JSON.stringify(matches)); }
    function saveBonus(){ localStorage.setItem(STORAGE_POINTS_BONUS, String(bonusPoints)); }

    // ---- Derived ----
    function computeProgress(g){
      if (g.progressMode === "percent") return clamp(Math.round(g.percent || 0));
      if (!g.subtasks || !g.subtasks.length) return 0;
      const done = g.subtasks.filter(t=>t.done).length;
      return Math.round((done / g.subtasks.length) * 100);
    }
    function priorityStars(p){ return "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(0,p) + "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(0,5-p); }

    // ---- Renderers ----
    function renderStats(){
      const total = goals.length;
      const completed = goals.filter(g => computeProgress(g) >= 100).length;
      const overdue = goals.filter(g => isOverdue(g.dueDate) && computeProgress(g) < 100).length;
      const trainMin = trainings.reduce((a,b)=>a+b.durationMin,0);
      const now = new Date();
      const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      const matchMonth = matches.filter(m => (m.date||'').startsWith(ym)).length;
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statCompleted').textContent = completed;
      document.getElementById('statOverdue').textContent = overdue;
      document.getElementById('statTrainMin').textContent = trainMin;
      document.getElementById('statMatchMonth').textContent = matchMonth;
    }
    function renderPoints(){
      const fromMatches = matches.reduce((sum,m)=> sum + (m.goals||0)*4 + (m.assists||0)*3 + (Number(m.rating)||0), 0);
      document.getElementById('pointsFromMatches').textContent = Math.round(fromMatches);
      document.getElementById('pointsTotal').textContent = Math.round(fromMatches + bonusPoints);
    }
    function renderCategoryFilter(){
      const sel = document.getElementById('categoryFilter');
      const options = new Set(["all"]);
      goals.forEach(g => options.add(g.category || "–î—Ä—É–≥–æ–µ"));
      sel.innerHTML = "";
      for(const o of options){ const opt = document.createElement('option'); opt.value=o; opt.textContent=(o==="all"?"–í—Å–µ":o); sel.appendChild(opt); }
      sel.value = category;
    }
    function renderTrainings(){
      const list = document.getElementById('trainingList');
      list.innerHTML = "";
      if (trainings.length===0){ list.innerHTML = '<p class="text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É üëÜ</p>'; return; }
      trainings.slice().reverse().forEach(t=>{
        const row = document.createElement('div');
        row.className = "flex items-center justify-between border rounded-xl p-3";
        row.innerHTML = \`<div><div class="font-medium">\${fmtDate(t.date)} ‚Äî \${t.type}</div><div class="text-xs text-gray-500">\${t.durationMin} –º–∏–Ω ¬∑ –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å \${t.intensity}\${t.notes? ' ¬∑ '+t.notes:''}</div></div><button class="btn" data-del="\${t.id}">–£–¥–∞–ª–∏—Ç—å</button>\`;
        row.querySelector('button').addEventListener('click', ()=>{ trainings = trainings.filter(x=>x.id!==t.id); saveTrainings(); renderAll(); });
        list.appendChild(row);
      });
    }
    function renderMatches(){
      const list = document.getElementById('matchList');
      list.innerHTML = "";
      if (matches.length===0){ list.innerHTML = '<p class="text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –º–∞—Ç—á–µ–π. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π üëÜ</p>'; return; }
      matches.slice().reverse().forEach(m=>{
        const row = document.createElement('div');
        row.className = "flex items-center justify-between border rounded-xl p-3";
        row.innerHTML = \`<div><div class="font-medium">\${fmtDate(m.date)} ‚Äî \${m.opponent} \${m.competition? '¬∑ '+m.competition:''}</div><div class="text-xs text-gray-500">\${m.minutes} –º–∏–Ω ¬∑ –ì–æ–ª—ã \${m.goals} ¬∑ –ê—Å—Å–∏—Å—Ç—ã \${m.assists} ¬∑ –û—Ü–µ–Ω–∫–∞ \${m.rating ?? '‚Äî'} ¬∑ –†–µ–∑: \${m.result ?? '‚Äî'}\${m.notes? ' ¬∑ '+m.notes:''}</div></div><button class="btn" data-del="\${m.id}">–£–¥–∞–ª–∏—Ç—å</button>\`;
        row.querySelector('button').addEventListener('click', ()=>{ matches = matches.filter(x=>x.id!==m.id); saveMatches(); renderAll(); });
        list.appendChild(row);
      });
    }
    function renderGoals(){
      const sec = document.getElementById('goalsSection');
      sec.innerHTML = "";
      // Filters
      const now = new Date();
      const monday = new Date(now); monday.setDate(now.getDate() - ((now.getDay() + 6) % 7));
      const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
      const filtered = goals.filter(g=>{
        if (category !== "all" && g.category !== category) return false;
        if (filter === "all") return true;
        if (filter === "active") return !g.archived;
        if (filter === "overdue") return !g.archived && isOverdue(g.dueDate) && computeProgress(g) < 100;
        if (filter === "thisWeek"){ const d=new Date((g.dueDate||todayISO())+"T00:00:00"); return d>=monday && d<=sunday; }
        return true;
      });
      if (filtered.length===0){
        const empty = document.createElement('div');
        empty.className = "text-center py-16 border-2 border-dashed rounded-2xl bg-white";
        empty.innerHTML = '<div class=\"mx-auto max-w-xl space-y-3\"><h2 class=\"text-2xl font-semibold\">–£ —Ç–µ–±—è –µ—â—ë –Ω–µ—Ç —Ü–µ–ª–µ–π</h2><p class=\"text-gray-500\">–î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é ‚Äî –∑–∞–¥–∞–π –¥–µ–¥–ª–∞–π–Ω, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏ –Ω–∞—á–Ω–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.</p><button class=\"btn btn-primary\" id=\"emptyNew\">+ –ù–æ–≤–∞—è —Ü–µ–ª—å</button></div>';
        sec.appendChild(empty);
        empty.querySelector('#emptyNew').addEventListener('click', openGoalDialogNew);
        return;
      }
      const grid = document.createElement('div');
      grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
      filtered.forEach(g=> grid.appendChild(goalCard(g)));
      sec.appendChild(grid);
    }
    function goalCard(g){
      const wrap = document.createElement('div');
      wrap.className = "rounded-2xl bg-white border p-4 space-y-3";
      const percent = computeProgress(g);
      wrap.innerHTML = \`
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xl font-semibold">\${g.title}</div>
            <div class="text-sm text-gray-500 mt-1 flex flex-wrap items-center gap-2">
              <span class="chip">\${g.category || '‚Äî'}</span>
              <span title="–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç">\${'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.slice(0,g.priority)}\${'‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ'.slice(0,5-g.priority)}</span>
              <span class="\${isOverdue(g.dueDate) ? 'text-red-600' : ''}">üìÖ \${fmtDate(g.dueDate)}</span>
            </div>
          </div>
          <div class="flex gap-2">
            <button class="btn" data-edit>‚úèÔ∏è</button>
            <button class="btn" data-del>üóëÔ∏è</button>
          </div>
        </div>
        \${g.description ? '<p class="text-sm text-gray-600">'+g.description+'</p>' : ''}
        <div>
          <div class="flex items-center justify-between text-sm mb-1"><span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span><span class="font-medium">\${percent}%</span></div>
          <div class="progress"><div style="width:\${percent}%"></div></div>
        </div>
        \${g.progressMode==='percent' ? \`
          <div class="flex items-end gap-2">
            <label class="flex-1 text-sm">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (%)
              <input type="number" min="0" max="100" value="\${g.percent ?? 0}" class="mt-1 w-full rounded-lg border px-3 py-2" data-pinp/>
            </label>
            <button class="btn" data-plus10>+10%</button>
          </div>\`
        : \`
          <div class="space-y-2">
            <button class="text-sm underline" data-toggle>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á–∏ (\${(g.subtasks||[]).filter(s=>s.done).length}/\${(g.subtasks||[]).length})</button>
            <div class="space-y-2 hidden" data-subwrap>
              <div class="flex gap-2 items-end">
                <input class="flex-1 rounded-lg border px-3 py-2" placeholder="–ù–æ–≤–∞—è –ø–æ–¥–∑–∞–¥–∞—á–∞" data-subtitle/>
                <input type="date" class="rounded-lg border px-3 py-2" data-subdue/>
                <button class="btn" data-subadd>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
              <div class="space-y-2" data-sublist></div>
            </div>
          </div>\`}
      \`;
      // actions
      wrap.querySelector('[data-edit]').addEventListener('click', ()=> openGoalDialogEdit(g));
      wrap.querySelector('[data-del]').addEventListener('click', ()=> { goals = goals.filter(x=>x.id!==g.id); saveGoals(); renderAll(); });
      if (g.progressMode==='percent'){
        wrap.querySelector('[data-plus10]').addEventListener('click', ()=>{
          g.percent = clamp((g.percent || 0) + 10);
          g.updatedAt = new Date().toISOString();
          saveGoals(); renderAll();
        });
        wrap.querySelector('[data-pinp]').addEventListener('change', (e)=>{
          g.percent = clamp(Number(e.target.value)||0);
          g.updatedAt = new Date().toISOString();
          saveGoals(); renderAll();
        });
      } else {
        const toggleBtn = wrap.querySelector('[data-toggle]');
        const subwrap = wrap.querySelector('[data-subwrap]');
        const sublist = wrap.querySelector('[data-sublist]');
        const subtitle = wrap.querySelector('[data-subtitle]');
        const subdue = wrap.querySelector('[data-subdue]');
        const subadd = wrap.querySelector('[data-subadd]');
        toggleBtn.addEventListener('click', ()=>{ subwrap.classList.toggle('hidden'); });
        function renderSubs(){
          sublist.innerHTML = '';
          (g.subtasks||[]).forEach(t=>{
            const r = document.createElement('div');
            r.className = "flex items-center justify-between border rounded-xl p-3 text-sm";
            r.innerHTML = \`<div class="flex items-center gap-3">
              <input type="checkbox" \${t.done?'checked':''} data-cb/>
              <div><div class="font-medium">\${t.title}</div><div class="text-xs text-gray-500">\${t.dueDate ? 'üìÖ '+fmtDate(t.dueDate): '–ë–µ–∑ —Å—Ä–æ–∫–∞'} \${(!t.done && t.dueDate && isOverdue(t.dueDate))?'<span class="ml-2 text-red-600">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>':''}</div></div></div>
              <button class="btn" data-del>–£–¥–∞–ª–∏—Ç—å</button>\`;
            r.querySelector('[data-cb]').addEventListener('change', (e)=>{ t.done = e.target.checked; g.updatedAt = new Date().toISOString(); saveGoals(); renderAll(); });
            r.querySelector('[data-del]').addEventListener('click', ()=>{ g.subtasks = (g.subtasks||[]).filter(x=>x!==t); g.updatedAt=new Date().toISOString(); saveGoals(); renderAll(); });
            sublist.appendChild(r);
          });
        }
        subadd.addEventListener('click', ()=>{
          const title = (subtitle.value||'').trim(); if (!title) return;
          const due = subdue.value || undefined;
          g.subtasks = g.subtasks || [];
          g.subtasks.push({ id: uid(), title, done:false, dueDate: due });
          g.updatedAt = new Date().toISOString();
          saveGoals(); renderAll();
        });
        renderSubs();
      }
      return wrap;
    }

    // ---- Dialog (create/edit) ----
    const dlg = document.getElementById('goalDialog');
    const dlgTitle = document.getElementById('goalDialogTitle');
    const gTitle = document.getElementById('gTitle');
    const gDesc = document.getElementById('gDesc');
    const gCategory = document.getElementById('gCategory');
    const gPriority = document.getElementById('gPriority');
    const gDue = document.getElementById('gDue');
    const gPercent = document.getElementById('gPercent');
    const percentWrap = document.getElementById('percentWrap');
    let dlgMode = 'new';
    let editingId = null;

    function openGoalDialogNew(){
      dlgMode = 'new'; editingId = null;
      dlgTitle.textContent = '–ù–æ–≤–∞—è —Ü–µ–ª—å';
      gTitle.value = ''; gDesc.value = '';
      gCategory.value = '–°–ø–æ—Ä—Ç'; gPriority.value = '3'; gDue.value = todayISO();
      document.querySelectorAll('input[name=\"pmode\"]').forEach(r=> r.checked = (r.value==='tasks'));
      percentWrap.style.display = 'none'; gPercent.value = '0';
      dlg.showModal();
    }
    function openGoalDialogEdit(goal){
      dlgMode = 'edit'; editingId = goal.id;
      dlgTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å';
      gTitle.value = goal.title || ''; gDesc.value = goal.description || '';
      gCategory.value = goal.category || '–°–ø–æ—Ä—Ç'; gPriority.value = String(goal.priority || 3);
      gDue.value = goal.dueDate || todayISO();
      document.querySelectorAll('input[name=\"pmode\"]').forEach(r=> r.checked = (r.value===goal.progressMode));
      percentWrap.style.display = (goal.progressMode==='percent')?'block':'none';
      gPercent.value = String(goal.percent || 0);
      dlg.showModal();
    }
    document.getElementById('btnNewGoal').addEventListener('click', openGoalDialogNew);
    document.addEventListener('change', (e)=>{
      if (e.target.name === 'pmode'){
        percentWrap.style.display = (e.target.value==='percent')?'block':'none';
      }
    });
    document.getElementById('goalSave').addEventListener('click', (e)=>{
      e.preventDefault();
      const pmode = [...document.querySelectorAll('input[name=\"pmode\"]')].find(r=>r.checked)?.value || 'tasks';
      const now = new Date().toISOString();
      const base = {
        id: editingId || uid(),
        title: gTitle.value.trim(),
        description: gDesc.value.trim() || undefined,
        category: gCategory.value,
        priority: Number(gPriority.value),
        startDate: todayISO(),
        dueDate: gDue.value || todayISO(),
        progressMode: pmode,
        percent: pmode==='percent' ? clamp(Number(gPercent.value)||0) : undefined,
        subtasks: [],
        createdAt: now,
        updatedAt: now,
        archived: false,
      };
      if (!base.title){ return; }
      if (dlgMode==='new'){ goals = [base, ...goals]; }
      else { goals = goals.map(g => g.id===editingId ? { ...g, ...base, subtasks: g.subtasks||[] } : g); }
      saveGoals(); dlg.close(); renderAll();
    });

    // ---- Events: filters ----
    document.querySelectorAll('[data-filter]').forEach(btn => {
      btn.addEventListener('click', ()=>{ filter = btn.dataset.filter; renderAll(); });
    });
    document.getElementById('categoryFilter').addEventListener('change', (e)=>{ category = e.target.value; renderAll(); });

    // ---- Events: football ----
    document.getElementById('addTraining').addEventListener('click', ()=>{
      const t = {
        id: uid(),
        date: document.getElementById('trainDate').value || todayISO(),
        type: document.getElementById('trainType').value,
        durationMin: Math.max(0, Number(document.getElementById('trainMinutes').value) || 0),
        intensity: Math.max(1, Math.min(5, Number(document.getElementById('trainIntensity').value) || 1)),
        notes: (document.getElementById('trainNotes').value || '').trim() || undefined
      };
      trainings.push(t); saveTrainings(); renderAll();
      document.getElementById('trainNotes').value = '';
    });
    document.getElementById('addMatch').addEventListener('click', ()=>{
      const opp = (document.getElementById('matchOpponent').value || '').trim();
      if (!opp) return;
      const m = {
        id: uid(),
        date: document.getElementById('matchDate').value || todayISO(),
        opponent: opp,
        competition: (document.getElementById('matchCompetition').value || '').trim() || undefined,
        minutes: Math.max(0, Number(document.getElementById('matchMinutes').value) || 0),
        goals: Math.max(0, Number(document.getElementById('matchGoals').value) || 0),
        assists: Math.max(0, Number(document.getElementById('matchAssists').value) || 0),
        rating: Number(document.getElementById('matchRating').value) || undefined,
        result: document.getElementById('matchResult').value || 'W',
        notes: (document.getElementById('matchNotes').value || '').trim() || undefined
      };
      matches.push(m); saveMatches(); renderAll();
      document.getElementById('matchOpponent').value = '';
      document.getElementById('matchCompetition').value = '';
      document.getElementById('matchNotes').value = '';
    });
    document.getElementById('bonusPoints').addEventListener('change', (e)=>{ bonusPoints = Number(e.target.value)||0; saveBonus(); renderPoints(); });

    // ---- Initial ----
    (function init(){
      loadAll();
      document.getElementById('trainDate').value = todayISO();
      document.getElementById('matchDate').value = todayISO();
      document.getElementById('gDue').value = todayISO();
      renderAll();
    })();

    function renderAll(){
      renderStats();
      renderPoints();
      renderCategoryFilter();
      renderTrainings();
      renderMatches();
      renderGoals();
    }
  </script>
</body>
</html>
